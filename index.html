<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>T.R.O.A.T. Training Repetitive Oral Attention Techniques</title>
<style>
  :root {
    --bg: #fff0f5;
    --pink1: #ffb6c1;
    --pink2: #ff69b4;
    --accent: #880044;
  }
  body { margin:0; background:var(--bg); font-family:system-ui,sans-serif; color:var(--accent); }
  .screen { position:fixed; inset:0; display:none; flex-direction:column; align-items:center; justify-content:flex-start; text-align:center; padding:20px; transition:opacity 1s; }
  .screen.show { display:flex; }
  #enter-screen { background:white; z-index:50; align-items:center; justify-content:center; text-align:center; opacity:1; transition:opacity 3s; }
  #enterBtn { background:black; color:white; border:none; font-size:18px; padding:12px 22px; cursor:pointer; font-weight:bold; }
  #enter-screen.fade-out { opacity:0; pointer-events:none; }
  #start-screen { background:var(--bg); z-index:40; display:none; }
  #begging-screen { background:#ffe6f2; z-index:30; opacity:0; }
  #begging-screen.show { opacity:1; }
  .component-frame { width:80%; max-width:400px; border:2px solid var(--pink1); border-radius:12px; background:var(--bg); margin:12px auto; opacity:0; transition:opacity 1s; }
  .component-frame.show { opacity:1; }
  .meter {
  height: 20px;
  position: relative;
  border-radius: 12px;        /* round the frame */
  overflow: hidden;           /* keeps fill inside curve */
  }
  .meter-fill {
  height: 100%; width: 0%;
  background: var(--pink1);
  border-right: 2px solid var(--pink2);
  transition: width .1s linear;
  border-radius: 12px 0 0 12px; /* round left side of fill */
  }
  .meter-label {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  font-size: 12px;
  font-weight: bold;
  color: var(--pink2);
  pointer-events: none;
  }
  .waveform { height:30px; display:block; }
  /* Feminine button styling */
  .fem-btn {
    margin-top: 20px;
    background: var(--pink2);
    color: white;
    border: none;
    font-size: 1rem;
    padding: 12px 28px;
    border-radius: 24px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transition: background 0.3s, transform 0.2s;
  }
  .fem-btn:hover {
    background: #e0559a;
    transform: scale(1.05);
  }
  /* Universal Feminine Button (except enter) */
  button:not(#enterBtn) {
    background: #ffb6c1;       /* pastel pink */
    color: #880044;            /* berry text */
    border: none;
    font-size: 1rem;
    padding: 12px 28px;
    border-radius: 32px;       /* pill shape */
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s, color 0.3s;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  button:not(#enterBtn):hover {
    background: #ff69b4;       /* hot pink hover */
    color: white;
    transform: scale(1.05);
  }
</style>
</head>
<body>

<!-- AUDIO -->
<audio id="enterClick" src="audio/enterClick.mp3" preload="auto"></audio>
<audio id="startSound1" src="audio/Start1.mp3" preload="auto"></audio>
<audio id="startSound2" src="audio/Start2.mp3" preload="auto"></audio>
<audio id="startSound3" src="audio/Start3.mp3" preload="auto"></audio>
<audio id="startSound4" src="audio/Start4.mp3" preload="auto"></audio>
<audio id="startSound5" src="audio/Start5.mp3" preload="auto"></audio>

<!-- ENTER SCREEN -->
<div id="enter-screen" class="screen show">
  <button id="enterBtn">ENTER</button>
</div>

<!-- START SCREEN -->
<div id="start-screen" class="screen">
  <main style="padding:20px; width:100%; max-width:720px; margin:0 auto; text-align:center;">
    <h1 style="margin-top:20px;"><b>ðŸ©· T.R.O.A.T. ðŸ©·</b></h1>
    <p style="font-weight:bold;">Training Repetitive Oral Attention Techniques</p>
    <button id="begin-btn" class="fem-btn">Begin Training</button>
  </main>
</div>

<!-- BEGGING SCREEN -->
<div id="begging-screen" class="screen">
  <div id="begging-text" style="margin:20px;"></div>
  <canvas id="waveform" width="400" height="30" class="component-frame"></canvas>
  <div class="meter component-frame">
    <div class="meter-fill" id="begFill"></div>
    <div class="meter-label" id="begLabel">0%</div>
  </div>
</div>

<script>
/* --------------------------
   Arrays
--------------------------- */
var readyClips = [
  "audio/ReadyToServe1.mp3",
  "audio/ReadyToServe2.mp3",
  "audio/ReadyToServe3.mp3"
];

/* --------------------------
   State
--------------------------- */
var meterValue = 0;
var running = false;
var audioCtx, analyser, micSource, dataArray;
var begFill, begLabel, begCtx;

/* --------------------------
   Elements
--------------------------- */
const enterScreen = document.getElementById("enter-screen");
const enterBtn = document.getElementById("enterBtn");
const startScreen = document.getElementById("start-screen");
const beginBtn = document.getElementById("begin-btn");
const beggingScreen = document.getElementById("begging-screen");
const beggingText = document.getElementById("begging-text");
const waveform = document.getElementById("waveform");

const enterClick = document.getElementById("enterClick");
const startSounds = [
  document.getElementById("startSound1"),
  document.getElementById("startSound2"),
  document.getElementById("startSound3"),
  document.getElementById("startSound4"),
  document.getElementById("startSound5")
];

/* --------------------------
   Enter + Intro (canon logic)
--------------------------- */
enterBtn.addEventListener("click", () => {
  try { enterClick.currentTime = 0; enterClick.play().catch(()=>{}); } catch(e){}
  const intro = startSounds[Math.floor(Math.random() * startSounds.length)];
  intro.volume = 1.0;
  intro.play().then(() => { intro.pause(); intro.currentTime = 0; }).catch(()=>{});
  enterScreen.classList.add("fade-out");

  setTimeout(() => {
    startScreen.style.display = "flex";
    setTimeout(() => {
      try { intro.currentTime = 0; intro.play().catch(()=>{}); } catch(e){}
    }, 2000);
  }, 3000);
});

/* --------------------------
   Begin Training â†’ Scene 1
--------------------------- */
beginBtn.addEventListener("click", function(){
  startScreen.style.display = "none";
  setTimeout(function(){
    beggingScreen.classList.add("show");
    beggingText.innerHTML =
      '<div id="welcomeText" style="opacity:0; transition:opacity 1s; font-size:1.5rem; margin-bottom:16px;">Welcome</div>' +
      '<div id="readyText" style="opacity:0; transition:opacity 1s; font-size:1.25rem; margin-bottom:20px;"></div>';

    var welcomeEl = document.getElementById("welcomeText");
    var readyEl = document.getElementById("readyText");
    setTimeout(function(){ welcomeEl.style.opacity = 1; }, 100);

    var file = readyClips[Math.floor(Math.random() * readyClips.length)];
    var audioEl = document.createElement("audio");
    audioEl.src = file;
    audioEl.autoplay = true;
    document.body.appendChild(audioEl);

    setTimeout(function(){ welcomeEl.style.opacity = 0; }, 10000);

    audioEl.addEventListener("ended", function(){
      readyEl.innerHTML = "Are you ready to serve?";
      readyEl.style.opacity = 1;
      setTimeout(function(){
        waveform.classList.add("show");
        document.querySelector("#begging-screen .meter").classList.add("show");
        begFill = document.getElementById("begFill");
        begLabel = document.getElementById("begLabel");
        begFill.style.width = "0%";
        begLabel.textContent = "0%";
        startMic();
      }, 2000);
      document.body.removeChild(audioEl);
    });
  }, 500);
});

/* --------------------------
   Mic + Waveform
--------------------------- */
async function startMic(){
  stopMic();
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  analyser = audioCtx.createAnalyser();
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  micSource = audioCtx.createMediaStreamSource(stream);
  micSource.connect(analyser);
  analyser.fftSize = 512;
  dataArray = new Uint8Array(analyser.frequencyBinCount);
  running = true;
  requestAnimationFrame(draw);
}

function stopMic(){
  running = false;
  try { if (audioCtx) audioCtx.close(); } catch(e){}
  audioCtx = null; analyser = null; micSource = null; dataArray = null;
  begCtx = waveform.getContext("2d");
  begCtx.clearRect(0,0,waveform.width,waveform.height);
}

function draw(){
  if (!running || !analyser) return;
  analyser.getByteTimeDomainData(dataArray);
  var sum = 0;
  for (var i=0; i<dataArray.length; i++){
    var v = (dataArray[i]-128)/128;
    sum += v*v;
  }
  var rms = Math.sqrt(sum / dataArray.length);

  if (rms > 0.03){
    meterValue += 4.5;
    if (meterValue > 100) meterValue = 100;
  } else {
    meterValue = Math.max(0, meterValue - 0.3);
  }

  begFill.style.width = meterValue + "%";
  begLabel.textContent = Math.floor(meterValue) + "%";

  begCtx = waveform.getContext("2d");
  begCtx.clearRect(0,0,waveform.width,waveform.height);
  begCtx.beginPath();
  var amp = Math.min(rms * 80, waveform.height/2);
  for (var x=0; x<waveform.width; x++){
    var y = waveform.height/2 + Math.sin(x/30) * amp;
    if (x===0) begCtx.moveTo(x,y); else begCtx.lineTo(x,y);
  }
  begCtx.strokeStyle = "#ff69b4";
  begCtx.lineWidth = 2;
  begCtx.stroke();

  requestAnimationFrame(draw);
}
</script>
</body>
</html>
